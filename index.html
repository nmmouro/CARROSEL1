<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Arial;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,0.03);
}

header img{height:66px}
header .title{font-size:20px;font-weight:700;color:var(--accent)}
header .clock{font-size:18px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:12px;
  height:calc(100vh - 80px);
  box-sizing:border-box;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:10px;
  overflow:auto;
}

.card h2{
  margin:0 0 8px;
  text-align:center;
  color:var(--accent);
  font-size:18px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:14px;
}

th,td{
  padding:8px;
  text-align:left;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

thead th{
  position:sticky;
  top:0;
  background:rgba(255,255,255,0.05);
}

tr.status-andamento{background: rgba(255,165,0,0.06)}
tr.status-concluido{background: rgba(0,200,120,0.06)}

@keyframes piscarCancelado{
  0%{opacity:1}
  50%{opacity:.3}
  100%{opacity:1}
}

tr.status-cancelado{
  background: rgba(155,17,17,0.18);
  text-decoration:line-through;
  animation:piscarCancelado 1s infinite;
}

.small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:6px;
}
</style>
</head>

<body>
<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTAÇÃO DIÁRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2 id="carousel-title">AGENDA SERVIÇO SOCIAL</h2>
    <div id="carousel">
      <div id="carousel-social">Carregando...</div>
      <div id="carousel-avisos" style="display:none">Carregando...</div>
    </div>
  </section>
</main>

<div class="small">Atualização automática a cada 60s • Fonte: Google Sheets</div>

<script>
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVIÇO SOCIAL";
const TAB_AVISOS = "AVISOS";

/* relógio*/
function updateClock(){
  const now = new Date();
  const optsDate = { day:"2-digit", month:"2-digit", year:"numeric" };
  const optsTime = { hour:"2-digit", minute:"2-digit", second:"2-digit" };
  document.getElementById("clock").textContent = now.toLocaleDateString("pt-BR",optsDate) + " — " + now.toLocaleTimeString("pt-BR",optsTime);
}
setInterval(updateClock,1000);
updateClock();

function formatCell(value){
  if (value === null || value === undefined) return "";

  // GViz geralmente vem como objeto {v,f}
  if (typeof value === "object"){
    if ("v" in value) return formatCell(value.v);
    if ("f" in value) return formatCell(value.f);
    return "";
  }

  const s = String(value).trim();

  /* =========================
     Date(YYYY,MM,DD[,HH,MM,SS])
     ========================= */
  const gvizDate = s.match(/^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),?(\d+)?)?\)$/);
  if (gvizDate){
    const ano = Number(gvizDate[1]);
    const mes = Number(gvizDate[2]) + 1;
    const dia = Number(gvizDate[3]);
    const hh  = gvizDate[4] !== undefined ? Number(gvizDate[4]) : null;
    const mm  = gvizDate[5] !== undefined ? Number(gvizDate[5]) : null;

    // Caso típico de HORA (Sheets usa 1899)
    if (ano === 1899){
      return `${String(hh ?? 0).padStart(2,"0")}:${String(mm ?? 0).padStart(2,"0")}`;
    }

    // Data + hora
    if (hh !== null){
      return `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano} ` +
             `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    }

    // Somente data
    return `${String(dia).padStart(2,"0")}/${String(mes).padStart(2,"0")}/${ano}`;
  }

  /* =========================
     Caso quebrado: 9,11,30,14,3,0)
     ========================= */
  const brokenTime = s.match(/(\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)?$/);
  if (brokenTime){
    const hh = Number(brokenTime[4]);
    const mm = Number(brokenTime[5]);
    return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
  }

  /* =========================
     ISO 2025-11-13 ou datetime
     ========================= */
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2}))?/);
  if (iso){
    if (iso[4]){
      return `${iso[3]}/${iso[2]}/${iso[1]} ${iso[4]}:${iso[5]}`;
    }
    return `${iso[3]}/${iso[2]}/${iso[1]}`;
  }

  return s;
}

  
/* helpers */
function parseGvizText(text){
  return JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m]));
}

/* render */
function renderTable(containerId, sheetName, g){
  const cols = g.table.cols.map(c=>c.label||"");
  let html="<table><thead><tr>";
  cols.forEach(h=>html+=`<th>${escapeHtml(h)}</th>`);
  html+="</tr></thead><tbody>";

  g.table.rows.forEach(r=>{
    const row = r.c.map(c=>c?c.v:"");
    const status = String(row[row.length-1]||"").toLowerCase();
    let cls="";
    if(status.includes("andamento"))cls="status-andamento";
    if(status.includes("concluido"))cls="status-concluido";
    if(status.includes("cancelado"))cls="status-cancelado";

    html+=`<tr class="${cls}">`;
    row.forEach(c=>html+=`<td>${escapeHtml(c)}</td>`);
    html+="</tr>";
  });

  html+="</tbody></table>";
  document.getElementById(containerId).innerHTML=html;
}

/* fetch */
async function fetchSheet(tab){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;
  const r=await fetch(url,{cache:"no-store"});
  return parseGvizText(await r.text());
}

/* carrossel */
let idx=0;
function toggleCarousel(){
  const ss=document.getElementById("carousel-social");
  const av=document.getElementById("carousel-avisos");
  const t=document.getElementById("carousel-title");

  if(idx===0){
    ss.style.display="block"; av.style.display="none";
    t.innerText="AGENDA SERVIÇO SOCIAL";
  }else{
    ss.style.display="none"; av.style.display="block";
    t.innerText="AVISOS";
  }
  idx=(idx+1)%2;
}

/* load */
async function loadAll(){
  const [p,a,s,v]=await Promise.all([
    fetchSheet(TAB_PAINEL),
    fetchSheet(TAB_AGENDA),
    fetchSheet(TAB_SS),
    fetchSheet(TAB_AVISOS)
  ]);

  renderTable("painel",TAB_PAINEL,p);
  renderTable("agenda",TAB_AGENDA,a);
  renderTable("carousel-social",TAB_SS,s);
  renderTable("carousel-avisos",TAB_AVISOS,v);
}

loadAll();
setInterval(toggleCarousel,6000);
</script>
</body>
</html>
