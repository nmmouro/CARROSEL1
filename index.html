<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Arial;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,0.03);
}

header img{height:66px}
header .title{font-size:20px;font-weight:700;color:var(--accent)}
header .clock{font-size:18px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:12px;
  height:calc(100vh - 80px);
  box-sizing:border-box;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:10px;
  overflow:auto;
}

.card h2{
  margin:0 0 8px;
  text-align:center;
  color:var(--accent);
  font-size:18px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:14px;
}

th,td{
  padding:8px;
  text-align:left;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

thead th{
  position:sticky;
  top:0;
  background:rgba(255,255,255,0.05);
}

tr.status-andamento{background: rgba(255,165,0,0.06)}
tr.status-concluido{background: rgba(0,200,120,0.06)}

@keyframes piscarCancelado{
  0%{opacity:1}
  50%{opacity:.3}
  100%{opacity:1}
}

tr.status-cancelado{
  background: rgba(155,17,17,0.18);
  text-decoration:line-through;
  animation:piscarCancelado 1s infinite;
}

.small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:6px;
}
</style>
</head>

<body>
<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTAÇÃO DIÁRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel">Carregando...</div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda">Carregando...</div>
  </section>

  <section class="card">
    <h2 id="carousel-title">AGENDA SERVIÇO SOCIAL</h2>
    <div id="carousel">
      <div id="carousel-social">Carregando...</div>
      <div id="carousel-avisos" style="display:none">Carregando...</div>
    </div>
  </section>
</main>

<div class="small">Atualização automática a cada 60s • Fonte: Google Sheets</div>

<script>
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVIÇO SOCIAL";
const TAB_AVISOS = "AVISOS";

/* relógio*/
function updateClock(){
  const now = new Date();
  const optsDate = { day:"2-digit", month:"2-digit", year:"numeric" };
  const optsTime = { hour:"2-digit", minute:"2-digit", second:"2-digit" };
  document.getElementById("clock").textContent = now.toLocaleDateString("pt-BR",optsDate) + " — " + now.toLocaleTimeString("pt-BR",optsTime);
}
setInterval(updateClock,1000);
updateClock();

function formatCell(raw, somenteHora=false){
  if (raw === null || raw === undefined) return "";

  // objetos com v/f
  if (typeof raw === "object"){
    if ("v" in raw) return formatCell(raw.v, somenteHora);
    if ("f" in raw) return formatCell(raw.f, somenteHora);
    try { return JSON.stringify(raw); } catch(e){ return String(raw); }
  }

  const s = String(raw).trim();

  // Date(YYYY,MM,DD[,HH,MM,SS])
  const dateMatch = s.match(/^Date\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d+)\s*)?)?\)/);
  if (dateMatch){
    const ano = Number(dateMatch[1]);
    const mes0 = Number(dateMatch[2]); // 0-based
    const dia = Number(dateMatch[3]);
    const hh = dateMatch[4] !== undefined ? Number(dateMatch[4]) : null;
    const mm = dateMatch[5] !== undefined ? Number(dateMatch[5]) : 0;

    // Se ano = 1899 (sheet time-only), retornar HH:MM
    if (ano === 1899){
      if (somenteHora) return `${String(hh ?? 0).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
      // se não pedir somenteHora, ainda retornar só hora (evitar mostrar '30/12/1899')
      return `${String(hh ?? 0).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    }

    // data real
    if (hh !== null && somenteHora){
      // se pediram somente hora e a data tem hora, retornar HH:MM
      return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
    }
    const mes = String(mes0 + 1).padStart(2,"0");
    return `${String(dia).padStart(2,"0")}/${mes}/${ano}` + (hh !== null ? ` ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}` : "");
  }

  // TimeOfDay(H,M,S)
  const timeMatch = s.match(/^TimeOfDay\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/);
  if (timeMatch){
    const hh = String(timeMatch[1]).padStart(2,"0");
    const mm = String(timeMatch[2]).padStart(2,"0");
    return somenteHora ? `${hh}:${mm}` : `${hh}:${mm}:${String(timeMatch[3]).padStart(2,"0")}`;
  }

  // ISO date/datetime YYYY-MM-DD[ T hh:mm:ss]
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}):?(\d{2})?)?/);
  if (iso){
    const ano = iso[1], mes = iso[2], dia = iso[3];
    if (iso[4]){
      const hh = String(iso[4]).padStart(2,"0"), mm = String(iso[5] ?? "00").padStart(2,"0");
      return somenteHora ? `${hh}:${mm}` : `${dia}/${mes}/${ano} ${hh}:${mm}`;
    }
    return `${dia}/${mes}/${ano}`;
  }

  // fallback: texto puro
  return s;
}

  
/* helpers */
function parseGvizText(text){
  return JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m]));
}

/* render */
function renderTable(containerId, sheetName, g){
  const cols = g.table.cols.map(c=>c.label||"");
  let html="<table><thead><tr>";
  cols.forEach(h=>html+=`<th>${escapeHtml(h)}</th>`);
  html+="</tr></thead><tbody>";

  g.table.rows.forEach(r=>{
    const row = r.c.map(c=>c?c.v:"");
    const status = String(row[row.length-1]||"").toLowerCase();
    let cls="";
    if(status.includes("andamento"))cls="status-andamento";
    if(status.includes("concluido"))cls="status-concluido";
    if(status.includes("cancelado"))cls="status-cancelado";

    html+=`<tr class="${cls}">`;
    row.forEach(c=>html+=`<td>${escapeHtml(c)}</td>`);
    html+="</tr>";

    row.forEach(cell=>{
  html += `<td>${escapeHtml(formatCell(cell))}</td>`;
});


  html+="</tbody></table>";
  document.getElementById(containerId).innerHTML=html;
}

/* fetch */
async function fetchSheet(tab){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;
  const r=await fetch(url,{cache:"no-store"});
  return parseGvizText(await r.text());
}

/* carrossel */
let idx=0;
function toggleCarousel(){
  const ss=document.getElementById("carousel-social");
  const av=document.getElementById("carousel-avisos");
  const t=document.getElementById("carousel-title");

  if(idx===0){
    ss.style.display="block"; av.style.display="none";
    t.innerText="AGENDA SERVIÇO SOCIAL";
  }else{
    ss.style.display="none"; av.style.display="block";
    t.innerText="AVISOS";
  }
  idx=(idx+1)%2;
}

/* load */
async function loadAll(){
  const [p,a,s,v]=await Promise.all([
    fetchSheet(TAB_PAINEL),
    fetchSheet(TAB_AGENDA),
    fetchSheet(TAB_SS),
    fetchSheet(TAB_AVISOS)
  ]);

  renderTable("painel",TAB_PAINEL,p);
  renderTable("agenda",TAB_AGENDA,a);
  renderTable("carousel-social",TAB_SS,s);
  renderTable("carousel-avisos",TAB_AVISOS,v);
}

loadAll();
setInterval(toggleCarousel,6000);
</script>
</body>
</html>
